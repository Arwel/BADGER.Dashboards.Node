{
    "name": "Late Rooms (Main)",
    "components": [
        {
            "type": "HealthCheck",
            "serverSet": "Moonstick",
            "title": "Status",
            "host": "10.44.22.158",
            "port": 3000,
            "span": 4
        },
        {
          "type": "SharedDataStore",
          "storeId": "RequestsData",
          "dataSource": "elasticsearch",
          "host": "http://logs.laterooms.com:9200",
          "timeProperties": [
            "query.filtered.filter.bool.must.0.range.@timestamp",
            "aggs.requests.date_histogram.extended_bounds"
          ],
          "intervalProperties": [
            "aggs.requests.date_histogram.interval"
          ],
          "queries": {
            "modifiers": {
              "value": { }
            },
            "query": {
              "query": {
                "filtered": {
                  "filter": {
                    "bool": {
                      "must": [
                        {
                          "range" : {
                            "@timestamp" : {
                                "from" : "now-60m"
                            }
                          }
                        },
                        {
                            "term": {
                                "type": "lr_varnish_request"
                            }
                        },
                        {
                            "term": {
                                "url_page_type": "home"
                            }
                        }
                      ]
                    }
                  }
                }
              },
              "aggs": {
                "requests" : {
                    "date_histogram" : {
                        "min_doc_count": 0,
                        "extended_bounds" : {
                            "min" : "now-60m",
                            "max" : "now"
                        },
                        "field" : "@timestamp",
                        "interval": "1m"
                    },
                    "aggs": {
                        "legacy": {
                            "filter": {
                                "term": {
                                    "is_moonstick": false
                                }
                            },
                            "aggs": {
                                "beacon": {
                                    "filter": {
                                        "term": {
                                            "tags": "beacon"
                                        }
                                    },
                                    "aggs": {
                                        "page_complete": {
                                            "stats": {
                                                "field": "timing_done"
                                            }
                                        },
                                        "percentiles": {
                                            "percentiles": {
                                                "field": "timing_done"
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        "moonstick": {
                            "filter": {
                                "term": {
                                    "is_moonstick": true
                                }
                            },
                            "aggs": {
                                "beacon": {
                                    "filter": {
                                        "term": {
                                            "tags": "beacon"
                                        }
                                    },
                                    "aggs": {
                                        "page_complete": {
                                            "stats": {
                                                "field": "timing_done"
                                            }
                                        },
                                        "percentiles": {
                                            "percentiles": {
                                                "field": "timing_done"
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
              },
              "size": 0
            }
          },
          "mappings": [
            { 
              "type": "extractFromDateHistogram",
              "aggregateName": "requests",
              "fields": {
                "moonstickRequests": "moonstick.doc_count",
                "legacyRequests": "legacy.doc_count",
                "legacyPageComplete": "legacy.beacon.percentiles.values.50|0",
                "moonstickPageComplete": "moonstick.beacon.percentiles.values.50|0"
              }
            }
          ]
        },
        {
            "type": "LineGraphAndCounter",
            "title": "Errors",
            "span": 8,
            "summaryText": "Errors per one minute on Moonstick",
            "dataSource": "elasticsearch",
            "host": "http://logs.laterooms.com:9200",
            "aggregateProperty": "errorsbytime",
            "timeProperties": [
              "query.filtered.filter.bool.must.0.range.@timestamp",
              "aggs.errorsbytime.date_histogram.extended_bounds"
            ],
            "intervalProperties": [
              "aggs.errorsbytime.date_histogram.interval"
            ],
            "query": {
              "query": {
                "filtered": {
                  "filter": {
                    "bool": {
                      "must": [
                        {
                          "range" : {
                            "@timestamp" : {
                                "from" : "now-60m"
                            }
                          }
                        },
                        {
                            "term": {
                                "type": "ms_errors"
                            }
                        }
                      ]
                    }
                  }
                }
              },
              "aggs": {
                "errorsbytime" : {
                        "date_histogram" : {
                            "min_doc_count": 0,
                            "extended_bounds" : {
                                "min" : "now-60m",
                                "max" : "now"
                            },
                            "field" : "@timestamp",
                            "interval" : "1m"
                        }
                    }
              },
              "size": 0
            },
            "graph": {
                "lineColor": "red"
            },
            "counter": {
                "title": "Errors in last 10mins",
                "className": "commission-graph-counter",
                "precision": 0
            }
        },
        {
            "type": "LineGraphAndCounter",
            "title": "Page Load Time (50th Percentile)",
            "summaryText": "Page Load time for the 50th percentile per minute on LateRooms.com (WEB)",
            "storeId": "RequestsData",
            "graph": {
              "lines": [
                { "id": "legacy", "color": "red", "value": "legacyPageComplete" },
                { "id": "moonstick", "color": "green", "value": "moonstickPageComplete" }
              ]
            },
            "counter": {
                "title": "Average Time to Page Load",
                "className": "counter-smallest-text",
                "type": "average",
                "window": {
                  "skip": 1,
                  "take": 10
                },
                "suffix": "ms",
                "precision": 0,
                "counters": [
                  { "id": "legacy", "color": "red", "value": "legacyPageComplete", "text": "Legacy" },
                  { "id": "moonstick", "color": "green", "value": "moonstickPageComplete", "text": "Moonstick" }
                ]
            }
        },
        {
            "type": "LineGraphAndCounter",
            "title": "Requests",
            "storeId": "RequestsData",
            "summaryText": "Requests per minute on Moonstick",
            "graph": {
              "window": {
                "skip": 0,
                "take": 60
              },
              "lines": [
                { "id": "moonstick-requests", "color": "green", "value": "moonstickRequests" },
                { "id": "legacy-requests", "color": "red", "value": "legacyRequests" }
              ]
            },
            "counter": {
                "title": "Requests per min (Last whole)",
                "className": "commission-graph-counter",
                "window": {
                  "skip": 1,
                  "take": 10
                },
                "precision": 0,
                "counters": [
                  { "id": "legacy-requests", "color": "red", "value": "legacyRequests", "text": "Legacy" },
                  { "id": "moonstick-requests", "color": "green", "value": "moonstickRequests", "text": "Moonstick" }
                ]
            }
        }
    ]
}