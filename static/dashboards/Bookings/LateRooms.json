{
    "id": "LateRooms",
    "name": "LateRooms.com Bookings",
    "components": [
        {
            "type": "LineGraphAndCounter",
            "title": "Bookings",
            "summaryText": "Bookings per minute on LateRooms.com (WEB)",
            "dataSource": "elasticsearch",
            "host": "http://logs.laterooms.com:9200",
            "aggregateProperty": "bookingsbytime",
            "query": {
              "query": {
                "filtered": {
                  "filter": {
                    "bool": {
                      "must": [
                        {
                          "range" : {
                            "@timestamp" : {
                                "from" : "now-60m"
                            }
                          }
                        },
                        {
                            "term": {
                                "type": "domain_events"
                            }
                        },
                        { 
                            "terms": {
                                "channelId":  [9, 10] 
                            }
                        }
                      ]
                    }
                  }
                }
              },
              "aggs": {
                "bookingsbytime" : {
                        "date_histogram" : {
                            "min_doc_count": 0,
                            "field" : "@timestamp",
                            "interval" : "1m"
                        }
                    }
              },
              "size": 0
            },
            "counterTitle": "Commission in last 10mins",
            "counter": {
                "title": "Bookings made in last 10mins",
                "precision": 0,
                "upClass": "good",
                "downClass": "bad"
            },
            "graph": {
                "className": "commission-graph",
                "lineColor": "green"
            }
        },
        {
            "type": "LineGraphAndCounter",
            "title": "Room Nights",
            "summaryText": "Room nights per minute on LateRooms.com (WEB)",
            "dataSource": "elasticsearch",
            "host": "http://logs.laterooms.com:9200",
            "aggregateProperty": "bookingsbytime",
            "valueProperty": "totalRoomNights.value",
            "query": {
              "query": {
                "filtered": {
                  "filter": {
                    "bool": {
                      "must": [
                        {
                          "range" : {
                            "@timestamp" : {
                                "from" : "now-60m"
                            }
                          }
                        },
                        {
                            "term": {
                                "type": "domain_events"
                            }
                        },
                        { 
                            "terms": {
                                "channelId":  [9, 10] 
                            }
                        }
                      ]
                    }
                  }
                }
              },
              "aggs": {
                "bookingsbytime" : {
                        "date_histogram" : {
                            "min_doc_count": 0,
                            "field" : "@timestamp",
                            "interval" : "1m"
                        },
                        "aggs": {
                            "totalRoomNights": {
                                "sum": {
                                    "script" : "doc['rooms'].value * doc['nights'].value"
                                }
                            }
                        }
                    }
              },
              "size": 0
            },
            "counter": {
                "title": "Room nights in last 10mins",
                "precision": 0,
                "upClass": "good",
                "downClass": "bad"
            },
            "graph": {
                "className": "commission-graph",
                "lineColor": "orange"
            }
        },
        {
            "type": "LineGraphAndCounter",
            "title": "Commission",
            "summaryText": "Total commission generated per minute on LateRooms.com (WEB)",
            "dataSource": "elasticsearch",
            "host": "http://logs.laterooms.com:9200",
            "aggregateProperty": "bookingsbytime",
            "valueProperty": "totalCommission.value",
            "query": {
              "query": {
                "filtered": {
                  "filter": {
                    "bool": {
                      "must": [
                        {
                          "range" : {
                            "@timestamp" : {
                                "from" : "now-60m"
                            }
                          }
                        },
                        {
                            "term": {
                                "type": "domain_events"
                            }
                        },
                        { 
                            "terms": {
                                "channelId":  [9, 10] 
                            }
                        }
                      ]
                    }
                  }
                }
              },
              "aggs": {
                "bookingsbytime" : {
                        "date_histogram" : {
                            "min_doc_count": 0,
                            "field" : "@timestamp",
                            "interval" : "1m"
                        },
                        "aggs": {
                            "totalCommission": {
                                "sum": {
                                    "field": "commissionValue"
                                }
                            }
                        }
                    }
              },
              "size": 0
            },
            "counterTitle": "Commission in last 10mins",
            "counter": {
                "title": "Commission made in last 10mins",
                "className": "commission-graph-counter",
                "prefix": "£",
                "precision": 0,
                "thresholds": [
                    {
                        "value": 700,
                        "sound": "/static/sounds/smb_mariodie.wav"
                    },
                    {
                        "value": 1500,
                        "sound": "/static/sounds/smb_stage_clear.wav"
                    }
                ],
                "upClass": "good",
                "downClass": "bad"
            },
            "graph": {
                "className": "commission-graph",
                "lineColor": "#411485"
            }
        },
        {
            "type": "LineGraphAndCounter",
            "title": "Total Transaction Value",
            "summaryText": "TTV generated per minute on LateRooms.com (WEB)",
            "dataSource": "elasticsearch",
            "host": "http://logs.laterooms.com:9200",
            "aggregateProperty": "bookingsbytime",
            "valueProperty": "totalCommission.value",
            "query": {
              "query": {
                "filtered": {
                  "filter": {
                    "bool": {
                      "must": [
                        {
                          "range" : {
                            "@timestamp" : {
                                "from" : "now-60m"
                            }
                          }
                        },
                        {
                            "term": {
                                "type": "domain_events"
                            }
                        },
                        { 
                            "terms": {
                                "channelId":  [9, 10] 
                            }
                        }
                      ]
                    }
                  }
                }
              },
              "aggs": {
                "bookingsbytime" : {
                        "date_histogram" : {
                            "min_doc_count": 0,
                            "field" : "@timestamp",
                            "interval" : "1m"
                        },
                        "aggs": {
                            "totalCommission": {
                                "sum": {
                                    "field": "totalAmountGbp"
                                }
                            }
                        }
                    }
              },
              "size": 0
            },
            "counterTitle": "Commission in last 10mins",
            "counter": {
                "title": "TTV in last 10mins",
                "className": "commission-graph-counter",
                "prefix": "£",
                "precision": 0,
                "upClass": "good",
                "downClass": "bad"
            },
            "graph": {
                "id": "elasticsearch commission",
                "className": "commission-graph",
                "lineColor": "blue"
            }
        },
        {
            "type": "LineGraphAndCounter",
            "title": "Bookings per session",
            "summaryText": "Bookings per session per minute on LateRooms.com (WEB)",
            "dataSource": "elasticsearch",
            "host": "http://logs.laterooms.com:9200",
            "aggregateProperty": "bookingsbytime",
            "propertyProcessor": {
                "type": "sessionCommission"
            },
            "query": {
               "query":{
                  "filtered":{
                     "filter":{
                        "bool":{
                           "must":[
                              {
                                 "range":{
                                    "@timestamp":{
                                       "from":"now-1h"
                                    }
                                 }
                              }
                           ]
                        }
                     }
                  }
               },
               "size":0,
                "aggs":{
                    "bookingsbytime" : {
                        "date_histogram" : {
                            "min_doc_count": 0,
                            "field" : "@timestamp",
                            "interval" : "1m"
                        },
                        "aggs": {
                            "requests" : {
                                "filter": {
                                    "term": {
                                        "type": "lr_varnish_request"
                                    }
                                },
                                "aggs": {
                                  "sessions": {
                                    "cardinality" : {
                                      "field" : "sessionId.raw"
                                    }
                                  }
                                }
                            },
                            "bookings" : {
                                "filter": {
                                    "term": {
                                        "type": "domain_events"
                                    }
                                }
                            }
                        }
                    }
                }
            },
            "counterTitle": "Commission in last 10mins",
            "counter": {
                "title": "Coversion in last 10mins",
                "className": "commission-graph-counter",
                "precision": 3,
                "type": "average",
                "upClass": "good",
                "downClass": "bad"
            },
            "graph": {
                "id": "elasticsearch commission",
                "className": "commission-graph",
                "lineColor": "purple"
            }
        }
    ]
}
